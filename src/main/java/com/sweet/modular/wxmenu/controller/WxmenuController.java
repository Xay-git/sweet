package com.sweet.modular.wxmenu.controller;import cn.hutool.json.JSONUtil;import com.alibaba.fastjson.JSON;import com.soecode.wxtools.api.IService;import com.soecode.wxtools.api.WxConfig;import com.soecode.wxtools.api.WxService;import com.soecode.wxtools.bean.WxMenu;import com.soecode.wxtools.exception.WxErrorException;import com.sweet.core.translationDict.DictParam;import com.sweet.core.translationDict.TranslationDict;import org.beetl.ext.simulate.JsonUtil;import org.springframework.transaction.annotation.Transactional;import org.springframework.web.bind.annotation.RequestBody;import org.springframework.web.bind.annotation.RequestMapping;import com.sweet.core.model.ResultBean;import com.sweet.core.model.system.LayuiPageInfo;import com.sweet.modular.wxmenu.entity.Wxmenu;import com.sweet.modular.wxmenu.service.WxmenuService;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.web.bind.annotation.RequestMapping;import com.sweet.core.util.StringUtil;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.ResponseBody;import org.springframework.stereotype.Controller;import java.util.List;/** * <p> * 微信菜单 前端控制器 * </p> * * @author admin * @since 2020-01-08 */@Controller@RequestMapping("/admin/wxmenu")public class WxmenuController {    @Autowired    WxmenuService wxmenuService;    IService iService = new WxService();    String appId = WxConfig.getInstance().getAppId();    @RequestMapping("")    public String index(){        return "/modular/wxmenu/index";    }    /**     * 列表页     */    @RequestMapping("/wxmenu_list")    public String list(){        return "/modular/wxmenu/wxmenu_list";    }    /**     * 编辑页     */    @RequestMapping("/wxmenu_edit")    public String edit(){        return "/modular/wxmenu/wxmenu_edit";    }    /**     * 添加/编辑     */    @RequestMapping("/editWxmenu")    @ResponseBody    public ResultBean editWxmenu(@RequestBody Wxmenu wxmenu){        if ((wxmenu.getTier().intValue() == 1)) {            wxmenu.setParentId(appId);        }else{            wxmenu.setParentId(appId+","+wxmenu.getParentId());        }        wxmenuService.saveOrUpdate(wxmenu);        return ResultBean.success(wxmenu);    }    /**     * 删除     */    @RequestMapping("/delWxmenu")    @ResponseBody    @Transactional    public ResultBean delWxmenu(Wxmenu wxmenu){        if(wxmenu.getTier()==1){            wxmenuService.delButtonsById(wxmenu.getButtonId());        }        wxmenuService.removeById(wxmenu);        return ResultBean.success(wxmenu);    }    /**     * 添加修改菜单     * @param menu     * @return     */    @RequestMapping("/getWxmenuDetail")    @ResponseBody    public ResultBean getWxmenuDetail(String buttonId){        List<Wxmenu> list = wxmenuService.getMenuByAppId(appId);        return ResultBean.success(list);    }    @RequestMapping("/saveButton")    @ResponseBody    @Transactional    public ResultBean saveButton(@RequestBody List<Wxmenu> wxmenu){        wxmenu.stream().forEach(button -> {            wxmenuService.updateById(button);            if(button.getSub_button()!=null){                button.getSub_button().stream().forEach(sub->{                    wxmenuService.updateById(sub);                });            }        });        return ResultBean.success(wxmenu);    }    @RequestMapping("/updateMenu")    @ResponseBody    @Transactional    public ResultBean updateMenu(String list,String menu) throws WxErrorException {        List<Wxmenu> wxmenuList =  JSON.parseArray(list,Wxmenu.class);        wxmenuList.stream().forEach(button -> {            wxmenuService.updateById(button);            if(button.getSub_button()!=null){                button.getSub_button().stream().forEach(sub->{                    wxmenuService.updateById(sub);                });            }        });        System.out.println(menu);        WxMenu wxMenu = JSONUtil.toBean(menu,WxMenu.class);        iService.createMenu(wxMenu,false);        return ResultBean.success();    }    /**     * 列表数据     */    @RequestMapping("/getWxmenuList")    @ResponseBody    public LayuiPageInfo getWxmenuList(Wxmenu Wxmenu){        LayuiPageInfo pageInfo = wxmenuService.findPageBySpec(Wxmenu);        return pageInfo;    }}